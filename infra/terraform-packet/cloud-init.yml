#cloud-config

users:
  - default
  - name: humacs
    gecos: Humacs
    primary_group: humacs
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin, docker
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDfOBYW4JREdUNAUY7k/XWKzH4pdx5GI+IfI67iyak7dvnv0sk3mfVHtNounEQuwW06vRiYLmKAG6BP4i97uvNVfoOIOdUSoaqiM/Q3OMPNUykKqh3kliMgX/tJJEsC27HtiDxrkxmgXbflE/JKc+3pSAYsjJkbeWUb2jmcpH8N2OpxeOLLOUeqZfQNsXVXUbfWFK2IcXUJNXUbuzZ4GiLifEoUfppD37e7V3HpNF+zDFim+5g/CYhqfrmlJ1ZCP2UG2Y8AVHl4N4NP2VHXvhl1dU7GkulU+cBA3BV/WF2e8J3cQCl+OFfRmztGeG4xKQPacNjE73bYI14jTSLOqcvhjwMFkr8t0MUCxmlDj1Nua6f3Js7Ft0zILpI20A4stV7h8f41VIehtNL4O+S21ps5dXz8UWcw90RZOmLSp6FPjFpedGqZcBH8ytMyGFiT4eag3SKQeIjNK2mgeaLqZOD+sEqRVWaQ89EX/loliep53cspa6a6hCUfW7WNuJqBtIUv+z9jfdT+Hv6TiLCQ82uQEhEr1KiWgOfNO7auds1cEoippoxnG9q9+Acw6Fe8laK3L3blHHatjxuMAn4Fp5N5GKBh/GxKMhf1CbMET3Q8HkgkuQqN5pXT+aR/517PYfXTMoGFZHWd87HBGg2MdpxBFnZ5LiqV0ByJvvuigh6C7w== caleb@titanlt
    shell: /bin/bash
    lock_passwd: false

timezone: Pacific/Auckland

package_update: true
package_upgrade: true
packages:
  - emacs-nox
  - tree
  - iproute2
  - net-tools
  - tcpdump
  - htop
  - iftop
  - tmux
  - tmate
  - bash-completion
  - less
  - xz-utils
  - sudo
  - curl
  - ca-certificates
  - libcap2-bin
  - git
  - openssh-client
  - postgresql-client-12
  - jq
  - inotify-tools
  - xtermcontrol
  - nodejs
  - gnupg2
  - tzdata
  - wget
  - python3-dev
  - xz-utils
  - apache2-utils
  - sqlite3
  - silversearcher-ag
  - build-essential
  - vim
  - rsync
  - unzip
  - iputils-ping
  - file
  - docker.io

runcmd:
  - curl -Lo /usr/local/bin/kind https://github.com/kubernetes-sigs/kind/releases/download/v0.8.1/kind-$(uname)-amd64
  - chmod +x /usr/local/bin/kind
  - curl -L https://storage.googleapis.com/kubernetes-release/release/v1.18.8/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl
  - chmod +x /usr/local/bin/kubectl
  - curl -L https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz | tar --directory /usr/local/bin --extract --xz --strip-components 1 tmate-2.4.0-static-linux-amd64/tmate
  - chmod +x /usr/local/bin/kind
  - curl -L https://get.helm.sh/helm-v3.3.0-linux-amd64.tar.gz | tar --directory /usr/local/bin --extract -xz --strip-components 1 linux-amd64/helm
  - curl -L https://dl.google.com/go/go1.15.linux-amd64.tar.gz | tar --directory /usr/local --extract --ungzip
  - curl -L -o /usr/local/bin/bazel https://github.com/bazelbuild/bazel/releases/download/2.2.0/bazel-2.2.0-linux-x86_64 && chmod +x /usr/local/bin/bazel
  - /bin/env GO111MODULE=on GOPATH=/usr/local/go /usr/local/go/bin/go get golang.org/x/tools/gopls@latest && /bin/env GO111MODULE=on GOPATH=/usr/local/go /usr/local/go/bin/go get -u github.com/stamblerre/gocode
  - chgrp users /var/run/docker.sock
  - mkdir /usr/share/humacs
  - curl -L https://raw.githubusercontent.com/humacs/humacs/main/kind-configs/kind-config.yaml > /usr/share/humacs/kind-cluster+registry.yaml
  - su humacs -c 'echo export "PATH=\$PATH:/usr/local/go/bin" >> /home/humacs/.bashrc'
  - su humacs -c 'bazel'
  - su humacs -c 'git clone --recursive https://github.com/humacs/humacs /home/humacs/humacs'
  - su humacs -c 'cd /home/humacs/humacs && ./install.sh'
  - su humacs -c 'cp /home/humacs/humacs/homedir/.tmate.conf /home/humacs'
  - su humacs -c 'cp /home/humacs/humacs/homedir/.tmux.conf /home/humacs'
  - su humacs -c 'cp /home/humacs/humacs/homedir/.gitconfig /home/humacs'
  - su humacs -c 'git clone https://github.com/cncf/apisnoop /home/humacs/apisnoop'
  - su humacs -c 'kind create cluster --config /usr/share/humacs/kind-cluster+registry.yaml'
  - su humacs -c 'kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml'
  - su humacs -c 'echo Waiting for nginx-ingress && kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s'
  - su humacs -c 'cd /home/humacs/apisnoop && export CURRENT_IP=127.0.0.1 NEW_IP=$(curl -4 ifconfig.co) && sed -i s:$CURRENT_IP:$NEW_IP:g kustomize/*yaml'
  - su humacs -c 'cd /home/humacs/apisnoop && kubectl apply -k kustomize'

output:
  all: '| tee -a /var/log/cloud-init-output.log'
