stages:
  - build-humacs
  - build-ii

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  DOCKERHUB_ORG: humacs

.registry-login: &registry-login |
  DOCKERHUB_AUTH=$(echo $DOCKERHUB_USER:$DOCKERHUB_TOKEN | base64)
  cat << EOF > /kaniko/.docker/config.json
  {
    "auths":{
      "$CI_REGISTRY": {
        "username":"$CI_REGISTRY_USER",
        "password":"$CI_REGISTRY_PASSWORD"
      },
      "https://index.docker.io/v1/": {
        "auth": "$DOCKERHUB_AUTH"
      }
    },
    "HttpHeaders": {
      "User-Agent": "Docker-Client/19.03.11 (linux)"
    }
  }
  EOF

.declare-extra-destinations: &declare-extra-destinations |
  if [ -n "$CI_COMMIT_TAG" ]; then KANIKO_EXTRA_DESTINATION="--destination $CI_REGISTRY_IMAGE/$REPOSITORY:$CI_COMMIT_TAG --destination $DOCKERHUB_ORG/$REPOSITORY:$CI_COMMIT_TAG"; fi

.build: &build |
  /kaniko/executor --cache=false --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE/$REPOSITORY:latest --destination $DOCKERHUB_ORG/$REPOSITORY:latest $KANIKO_EXTRA_DESTINATION

build-humacs:
  stage: build-humacs
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.13.0
    entrypoint: [""]
  variables:
    REPOSITORY: humacs
  before_script:
    - *registry-login
    - *declare-extra-destinations
  script:
    - *build

build-ii:
  stage: build-ii
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.13.0
    entrypoint: [""]
  variables:
    REPOSITORY: ii
  before_script:
    - *registry-login
    - *declare-extra-destinations
  script:
    - *build
